# 📝 7장 연습문제: 파일 업로드 & 에러 처리

---

## 🎯 객관식 10문제

#### **1번. 파일 업로드 HTML 폼에서 필수적으로 필요한 것은?**

① `method="GET"`  
② `method="POST"` 만  
③ `enctype="multipart/form-data"` 만  
④ `method="POST"` 와 `enctype="multipart/form-data"` 모두

---

#### **2번. $_FILES 배열에서 파일명을 가져오려면?**

① `$_FILES['upload_file']['name']`  
② `$_FILES['upload_file']['type']`  
③ `$_FILES['upload_file']['tmp_name']`  
④ `$_FILES['upload_file']['error']`

---

#### **3번. 파일이 선택되지 않은 경우 $_FILES의 error 값은?**

① 0  
② 1  
③ 4  
④ 7

---

#### **4번. 다음 코드에서 ?에 들어갈 것은?**

```php
$filename = $_FILES['upload_file']['name'];
$ext = strtolower(pathinfo($filename, ?));
```

① PATHINFO_DIRNAME  
② PATHINFO_BASENAME  
③ PATHINFO_EXTENSION  
④ PATHINFO_FILENAME

---

#### **5번. 파일 크기 5MB를 바이트 단위로 변환하면?**

① 5000000  
② 5 * 1024 * 1024  
③ 5 * 1000 * 1000  
④ 5242880 (②와 ④ 결과는 같음)

---

#### **6번. 파일 확장자 검증에서 화이트리스트 방식은?**

① 위험한 확장자를 모두 나열하고 제외  
② 허용하는 확장자만 나열하고 확인  
③ 모든 확장자 허용  
④ 파일명 길이로만 검증

---

#### **7번. 다음 코드의 in_array() 결과는?**

```php
$ext = 'jpg';
$allowed = ['jpg', 'png', 'gif'];
echo in_array($ext, $allowed);
```

① true (1로 출력)  
② false (빈 문자열)  
③ 0  
④ 오류 발생

---

#### **8번. move_uploaded_file()의 역할은?**

① 파일의 확장자를 확인한다  
② 임시 파일을 실제 경로로 이동한다  
③ 파일을 암호화한다  
④ 파일을 압축한다

---

#### **9번. try-catch 블록의 역할은?**

① 파일을 업로드하기  
② 에러를 처리하고 프로그램이 중단되지 않게 함  
③ 파일을 암호화하기  
④ 폼 데이터를 검증하기

---

#### **10번. throw new Exception("메시지")의 역할은?**

① 프로그램을 종료한다  
② 에러를 발생시키고 catch 블록으로 이동한다  
③ 메시지를 즉시 출력한다  
④ 파일을 삭제한다

---

## 💻 실기작업형 5문제

### **문제 1: 파일 업로드 HTML 폼**

**요구사항:**
- HTML 폼 작성 (method="POST", enctype="multipart/form-data")
- 파일 선택 입력 필드 (name="upload_file")
- 업로드 버튼
- 파일 선택 필수 (required)

**파일명**: `file_upload_form.php`

```php
<?php
// 여기에 코드를 작성하세요

?>
```

---

### **문제 2: 파일 검증 (크기 및 확장자)**

**요구사항:**
- POST로 파일 수신
- 파일이 선택되었는지 확인 (error === 4)
- 파일 크기 검증 (5MB 이하)
- 파일 확장자 검증 (jpg, png, gif만 허용)
- 화이트리스트 사용 (in_array 활용)
- pathinfo(PATHINFO_EXTENSION) 사용
- strtolower()로 대소문자 통일
- 검증 결과 메시지 표시

**파일명**: `file_validation.php`

```php
<?php
// 여기에 코드를 작성하세요

?>
```

---

### **문제 3: 파일명 정제 및 저장**

**요구사항:**
- 파일 확장자 추출
- 새 파일명 생성 (time() + rand() 사용)
- 저장 경로 설정 ('uploads/' 디렉토리)
- move_uploaded_file()로 임시 파일 이동
- 성공/실패 메시지 표시
- HTML 폼 포함

**파일명**: `file_save.php`

```php
<?php
// 여기에 코드를 작성하세요

?>
```

---

### **문제 4: 에러 처리 (try-catch)**

**요구사항:**
- try-catch 블록으로 감싸기
- 파일 미선택: throw new Exception()
- 파일 에러: throw new Exception()
- 파일 크기 초과: throw new Exception()
- 확장자 미허용: throw new Exception()
- 파일 이동 실패: throw new Exception()
- catch 블록에서 에러 메시지 표시
- $e->getMessage() 사용

**파일명**: `file_upload_with_error.php`

```php
<?php
// 여기에 코드를 작성하세요

?>
```

---

### **문제 5: 파일 목록 조회**

**요구사항:**
- uploads/ 디렉토리 확인 (is_dir)
- scandir()로 파일 목록 가져오기
- array_diff()로 '.' '..' 제거
- pathinfo()로 확장자 추출
- 이미지 파일 판별 함수 작성
- 이미지는 <img> 태그로 표시
- 비이미지는 파일명만 표시
- htmlspecialchars()로 안전 처리

**파일명**: `file_list.php`

```php
<?php
// 여기에 코드를 작성하세요

?>
```

---

---

## ✅ 정답 및 풀이

### **객관식 정답**

| 문제 | 정답 | 풀이 |
|------|------|------|
| 1번 | **④ method="POST"와 enctype="multipart/form-data" 모두** | 파일 업로드에는 두 가지 속성 모두 필수입니다 |
| 2번 | **① `$_FILES['upload_file']['name']`** | 원본 파일명은 ['name'] 키에 저장됩니다 |
| 3번 | **③ 4** | 파일이 선택되지 않으면 error는 4입니다 |
| 4번 | **③ PATHINFO_EXTENSION** | 파일 확장자를 추출하려면 PATHINFO_EXTENSION을 사용합니다 |
| 5번 | **② 또는 ④ (둘 다 5242880)** | 5MB = 5 * 1024 * 1024 = 5242880 바이트입니다 |
| 6번 | **② 허용하는 확장자만 나열하고 확인** | 화이트리스트 방식은 허용하는 것만 명시적으로 나열합니다 |
| 7번 | **① true (1로 출력)** | in_array('jpg', ['jpg', 'png', 'gif'])는 true입니다 |
| 8번 | **② 임시 파일을 실제 경로로 이동한다** | move_uploaded_file()은 임시 파일을 실제 저장 경로로 이동합니다 |
| 9번 | **② 에러를 처리하고 프로그램이 중단되지 않게 함** | try-catch는 에러 발생 시에도 프로그램이 계속 실행되도록 합니다 |
| 10번 | **② 에러를 발생시키고 catch 블록으로 이동한다** | throw new Exception()은 예외를 발생시킵니다 |

---

### **실기작업형 풀이**

#### **문제 1: 파일 업로드 HTML 폼 - 정답**

```php
<?php
/**
 * file_upload_form.php - 파일 업로드 폼
 */

?>

<!DOCTYPE html>
<html>
<head>
    <title>파일 업로드</title>
    <style>
        body { font-family: '맑은 고딕'; margin: 50px; }
        .container { max-width: 400px; padding: 20px; border: 1px solid #ddd; }
        input[type="file"] { padding: 8px; margin: 10px 0; width: 100%; }
        button { background-color: navy; color: white; padding: 10px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h1>📁 파일 업로드</h1>
    
    <!-- 필수 속성: method="POST", enctype="multipart/form-data" -->
    <form method="POST" enctype="multipart/form-data">
        <label>파일 선택:</label>
        <!-- 필수 속성: type="file", required -->
        <input type="file" name="upload_file" required>
        
        <button type="submit">업로드</button>
    </form>
</div>

</body>
</html>
```

**검증:**
✓ method="POST" 사용
✓ enctype="multipart/form-data" 포함
✓ <input type="file" name="upload_file"> 포함
✓ required 속성 포함
✓ 업로드 버튼 포함

---

#### **문제 2: 파일 검증 (크기 및 확장자) - 정답**

```php
<?php
/**
 * file_validation.php - 파일 크기 및 확장자 검증
 */

$validation_message = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    
    // 1단계: 파일이 선택되었는가?
    if ($_FILES['upload_file']['error'] === 4) {
        $validation_message = "❌ 파일을 선택하세요";
    } else {
        
        // 2단계: 파일 크기 검증 (5MB 이하)
        $max_size = 5 * 1024 * 1024;  // 5MB를 바이트로 변환
        $file_size = $_FILES['upload_file']['size'];
        
        if ($file_size > $max_size) {
            $validation_message = "❌ 파일 크기가 5MB를 초과합니다";
        } else {
            
            // 3단계: 파일 확장자 검증 (화이트리스트)
            $filename = $_FILES['upload_file']['name'];
            // pathinfo()로 확장자 추출, strtolower()로 대소문자 통일
            $ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
            
            // 허용하는 확장자 목록
            $allowed = ['jpg', 'jpeg', 'png', 'gif'];
            
            // in_array()로 확인
            if (!in_array($ext, $allowed)) {
                $validation_message = "❌ jpg, png, gif 파일만 업로드 가능합니다";
            } else {
                $validation_message = "✅ 파일 검증 완료";
            }
        }
    }
}

?>

<!DOCTYPE html>
<html>
<head>
    <title>파일 검증</title>
    <style>
        body { font-family: '맑은 고딕'; margin: 50px; }
        .container { max-width: 400px; padding: 20px; border: 1px solid #ddd; }
        input[type="file"] { padding: 8px; margin: 10px 0; width: 100%; }
        button { background-color: navy; color: white; padding: 10px; width: 100%; cursor: pointer; }
        .message { padding: 10px; margin: 10px 0; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>

<div class="container">
    <h1>검증</h1>
    
    <form method="POST" enctype="multipart/form-data">
        <input type="file" name="upload_file" required>
        <button type="submit">검증</button>
    </form>
    
    <?php if ($validation_message): ?>
        <div class="message <?php echo strpos($validation_message, '✅') ? 'success' : 'error'; ?>">
            <?php echo $validation_message; ?>
        </div>
    <?php endif; ?>
</div>

</body>
</html>
```

**검증:**
✓ error === 4 파일 미선택 확인
✓ 파일 크기 검증 (5MB)
✓ pathinfo(PATHINFO_EXTENSION) 확장자 추출
✓ strtolower() 대소문자 통일
✓ 화이트리스트 ['jpg', 'jpeg', 'png', 'gif']
✓ in_array()로 확인
✓ 검증 결과 메시지 표시

---

#### **문제 3: 파일명 정제 및 저장 - 정답**

```php
<?php
/**
 * file_save.php - 파일명 정제 및 저장
 */

$save_message = '';
$saved_filename = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    
    // 1단계: 파일 확장자 추출
    $filename = $_FILES['upload_file']['name'];
    $ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
    
    // 2단계: 새 파일명 생성 (time() + rand() 사용)
    // time(): 현재 시간 (유닉스 타임스탬프)
    // rand(1000, 9999): 1000~9999 사이의 난수
    // 결과: 1673456789_5432.jpg
    $new_filename = time() . '_' . rand(1000, 9999) . '.' . $ext;
    
    // 3단계: 저장 경로 설정
    $upload_dir = 'uploads/';
    $destination = $upload_dir . $new_filename;
    
    // 4단계: move_uploaded_file()로 임시 파일 이동
    $tmp_file = $_FILES['upload_file']['tmp_name'];
    
    if (move_uploaded_file($tmp_file, $destination)) {
        $save_message = "✅ 파일 '{$new_filename}'이 저장되었습니다";
        $saved_filename = $new_filename;
    } else {
        $save_message = "❌ 파일 저장에 실패했습니다";
    }
}

?>

<!DOCTYPE html>
<html>
<head>
    <title>파일 저장</title>
    <style>
        body { font-family: '맑은 고딕'; margin: 50px; }
        .container { max-width: 400px; padding: 20px; border: 1px solid #ddd; }
        input[type="file"] { padding: 8px; margin: 10px 0; width: 100%; }
        button { background-color: navy; color: white; padding: 10px; width: 100%; cursor: pointer; }
        .message { padding: 10px; margin: 10px 0; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>

<div class="container">
    <h1>파일 저장</h1>
    
    <form method="POST" enctype="multipart/form-data">
        <label>파일 선택:</label>
        <input type="file" name="upload_file" required>
        <button type="submit">저장</button>
    </form>
    
    <?php if ($save_message): ?>
        <div class="message <?php echo strpos($save_message, '✅') ? 'success' : 'error'; ?>">
            <?php echo $save_message; ?>
        </div>
    <?php endif; ?>
    
    <?php if ($saved_filename): ?>
        <p>저장된 파일: <strong><?php echo htmlspecialchars($saved_filename); ?></strong></p>
    <?php endif; ?>
</div>

</body>
</html>
```

**검증:**
✓ pathinfo(PATHINFO_EXTENSION) 확장자 추출
✓ strtolower() 대소문자 통일
✓ time() + rand(1000, 9999) 새 파일명 생성
✓ 'uploads/' 저장 디렉토리
✓ move_uploaded_file() 임시 파일 이동
✓ 성공/실패 메시지 표시
✓ htmlspecialchars() 안전 처리

---

#### **문제 4: 에러 처리 (try-catch) - 정답**

```php
<?php
/**
 * file_upload_with_error.php - try-catch로 에러 처리
 */

$upload_message = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    
    try {
        // 1단계: 파일이 선택되었는가?
        if ($_FILES['upload_file']['error'] === 4) {
            throw new Exception("파일을 선택하세요");
        }
        
        // 2단계: 업로드 에러 확인
        if ($_FILES['upload_file']['error'] !== 0) {
            throw new Exception("파일 업로드 중 에러 발생");
        }
        
        // 3단계: 파일 크기 검증
        $max_size = 5 * 1024 * 1024;
        if ($_FILES['upload_file']['size'] > $max_size) {
            throw new Exception("파일 크기가 5MB를 초과합니다");
        }
        
        // 4단계: 파일 확장자 검증
        $filename = $_FILES['upload_file']['name'];
        $ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
        $allowed = ['jpg', 'jpeg', 'png', 'gif'];
        
        if (!in_array($ext, $allowed)) {
            throw new Exception("이미지 파일만 업로드 가능합니다");
        }
        
        // 5단계: 파일 이동
        $new_filename = time() . '_' . rand(1000, 9999) . '.' . $ext;
        $destination = 'uploads/' . $new_filename;
        
        if (!move_uploaded_file($_FILES['upload_file']['tmp_name'], $destination)) {
            throw new Exception("파일 저장에 실패했습니다");
        }
        
        // 성공
        $upload_message = "✅ 파일 '{$new_filename}'이 업로드되었습니다";
        
    } catch (Exception $e) {
        // 에러 처리: $e->getMessage()로 메시지 반환
        $upload_message = "❌ " . $e->getMessage();
    }
}

?>

<!DOCTYPE html>
<html>
<head>
    <title>파일 업로드 (에러 처리)</title>
    <style>
        body { font-family: '맑은 고딕'; margin: 50px; }
        .container { max-width: 400px; padding: 20px; border: 1px solid #ddd; }
        input[type="file"] { padding: 8px; margin: 10px 0; width: 100%; }
        button { background-color: navy; color: white; padding: 10px; width: 100%; cursor: pointer; }
        .message { padding: 10px; margin: 10px 0; }
        .success { color: green; background-color: #f0f0f0; }
        .error { color: red; background-color: #ffe6e6; }
    </style>
</head>
<body>

<div class="container">
    <h1>파일 업로드 (에러 처리)</h1>
    
    <form method="POST" enctype="multipart/form-data">
        <label>파일 선택:</label>
        <input type="file" name="upload_file" required>
        <button type="submit">업로드</button>
    </form>
    
    <?php if ($upload_message): ?>
        <div class="message <?php echo strpos($upload_message, '✅') ? 'success' : 'error'; ?>">
            <?php echo $upload_message; ?>
        </div>
    <?php endif; ?>
</div>

</body>
</html>
```

**검증:**
✓ try-catch 블록 구조
✓ throw new Exception("메시지")로 에러 발생
✓ error === 4 파일 미선택 확인
✓ error !== 0 업로드 에러 확인
✓ 파일 크기 검증
✓ 확장자 검증
✓ move_uploaded_file() 실패 처리
✓ catch 블록에서 $e->getMessage() 사용

---

#### **문제 5: 파일 목록 조회 - 정답**

```php
<?php
/**
 * file_list.php - uploads/ 디렉토리의 파일 목록 조회
 */

// 이미지 확장자 목록
$image_extensions = ['jpg', 'jpeg', 'png', 'gif'];

// uploads 디렉토리의 파일 목록 가져오기
$upload_dir = 'uploads/';
$files = [];

// is_dir(): 디렉토리 존재 여부 확인
if (is_dir($upload_dir)) {
    // scandir(): 디렉토리의 모든 파일과 폴더를 배열로 반환
    // array_diff(): $array1에서 $array2 요소 제거
    // ['.', '..'] = 현재, 상위 디렉토리 제거
    $files = array_diff(scandir($upload_dir), ['.', '..']);
}

/**
 * 파일이 이미지인지 판별하는 함수
 * @param string $filename 파일명
 * @param array $allowed_ext 허용하는 확장자
 * @return bool 이미지면 true, 아니면 false
 */
function isImage($filename, $allowed_ext) {
    // pathinfo()로 확장자 추출
    $ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
    
    // in_array()로 확인
    return in_array($ext, $allowed_ext);
}

?>

<!DOCTYPE html>
<html>
<head>
    <title>파일 목록</title>
    <style>
        body { font-family: '맑은 고딕'; margin: 50px; }
        .container { max-width: 800px; }
        h1 { color: navy; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .file-item { border: 1px solid #ddd; padding: 15px; text-align: center; }
        .file-item img { max-width: 100%; max-height: 150px; margin-bottom: 10px; }
        .file-name { font-size: 12px; color: #666; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <h1>📁 업로드된 파일 목록</h1>
    
    <div class="file-grid">
        <?php foreach ($files as $file): ?>
            <div class="file-item">
                <!-- 이미지 판별: isImage() 함수 사용 -->
                <?php if (isImage($file, $image_extensions)): ?>
                    <!-- 이미지 파일: <img> 태그로 표시 -->
                    <img src="<?php echo htmlspecialchars($upload_dir . $file); ?>" 
                         alt="<?php echo htmlspecialchars($file); ?>">
                <?php else: ?>
                    <!-- 비이미지 파일: 파일 아이콘 표시 -->
                    <div style="font-size: 48px;">📄</div>
                <?php endif; ?>
                
                <!-- 파일명 표시 (htmlspecialchars로 안전 처리) -->
                <div class="file-name"><?php echo htmlspecialchars($file); ?></div>
            </div>
        <?php endforeach; ?>
    </div>
    
    <!-- 파일이 없는 경우 메시지 표시 -->
    <?php if (empty($files)): ?>
        <p>업로드된 파일이 없습니다.</p>
    <?php endif; ?>
</div>

</body>
</html>
```

**검증:**
✓ is_dir()로 디렉토리 존재 확인
✓ scandir()로 파일 목록 가져오기
✓ array_diff()로 '.' '..' 제거
✓ pathinfo(PATHINFO_EXTENSION)로 확장자 추출
✓ strtolower()로 대소문자 통일
✓ isImage() 함수 작성
✓ in_array()로 이미지 판별
✓ 이미지는 <img> 태그로 표시
✓ 비이미지는 파일명만 표시
✓ htmlspecialchars()로 안전 처리

---

## 💡 풀이 팁

### **객관식 풀이 전략**

1. **파일 업로드 필수**: method="POST" + enctype="multipart/form-data"
2. **$_FILES 구조**: ['name', 'type', 'size', 'tmp_name', 'error']
3. **파일 선택 안 함**: error === 4
4. **확장자 추출**: pathinfo(PATHINFO_EXTENSION) + strtolower()
5. **크기 계산**: 5MB = 5 * 1024 * 1024
6. **화이트리스트**: 허용하는 것만 명시적 나열
7. **배열 확인**: in_array($ext, $allowed)
8. **파일 이동**: move_uploaded_file($tmp, $dest)
9. **에러 처리**: try-catch로 감싸기
10. **예외 발생**: throw new Exception()

### **실기작업형 풀이 전략**

1. **폼 작성**: method="POST" + enctype="multipart/form-data" + type="file"
2. **검증**: error 확인 → 크기 확인 → 확장자 확인 (순서 중요)
3. **파일명**: time() + rand() + 확장자 (중복 방지)
4. **저장**: move_uploaded_file($tmp, $dest)
5. **에러 처리**: try-catch + throw new Exception
6. **목록**: is_dir() → scandir() → array_diff() → pathinfo()
7. **출력**: htmlspecialchars()로 안전 처리

---

**수고했습니다! 화이팅! 💪**

---

조정현 교수(peterchokr@gmail.com)  
영남이공대학교

