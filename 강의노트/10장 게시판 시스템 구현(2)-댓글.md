# 10장: 게시판 시스템 구현 (2/3) - 댓글 기능

---

## 📌 이 장에서 배우는 것

### **무엇을 만드나요?**
👥 **댓글 시스템** - 사람들이 게시글에 의견을 달 수 있는 기능

### **왜 필요한가요?**
- 📝 게시글에 대한 피드백/의견 수집
- 💬 사용자 간 상호작용 증진
- 🔗 게시글과 댓글의 관계 관리

### **어떻게 만드나요?**
```
1단계: 댓글 데이터베이스 설계 (comments 테이블)
2단계: 댓글 작성/조회/수정/삭제 파일 생성
3단계: 게시글에 댓글 표시
```

---

## 학습목표

이 장을 학습하고 나면 다음을 할 수 있습니다:

✅ 댓글 시스템을 설계하고 데이터베이스를 구성할 수 있습니다.
✅ 댓글을 작성(Create), 조회(Read), 수정(Update), 삭제(Delete)할 수 있습니다.
✅ 게시글에 달린 댓글을 목록으로 표시하고 관리할 수 있습니다.

---

## 1️⃣ 댓글 데이터베이스 설계

### 1-1 댓글 시스템 이해

**댓글이란?** 게시글에 대한 사용자들의 의견/반응입니다.

#### 📊 현실의 예시

```
┌─────────────────────────────────────┐
│ 게시글 1번: "PHP 기초 강좌"         │
│ 조회수: 100                         │
├─────────────────────────────────────┤
│ 💬 댓글 1: "좋은 글이네요!"        │
│    작성자: 김철수 | 날짜: 2024-01-12 │
│                                     │
│ 💬 댓글 2: "도움이 되었어요"        │
│    작성자: 이영희 | 날짜: 2024-01-11 │
│                                     │
│ 💬 댓글 3: "감사합니다!"            │
│    작성자: 박민수 | 날짜: 2024-01-10 │
└─────────────────────────────────────┘
```

#### 🔗 데이터베이스 관계

```
posts 테이블              comments 테이블
┌──────────────────┐     ┌──────────────────────┐
│ id: 1            │     │ id: 1                │
│ title: "..."     │1 ←N─│ post_id: 1          │
│ content: "..."   │     │ user_id: 1          │
│ user_id: 1       │     │ content: "..."      │
└──────────────────┘     │ created_at: 시간    │
                         └──────────────────────┘
                                  │
                         ┌────────┴────────┐
                         │                 │
                      댓글 2            댓글 3
                    (post_id:1)       (post_id:1)

→ 1개의 게시글 = N개의 댓글 (1:N 관계)
```

### 1-2 테이블 설계

**comments 테이블** (댓글 정보)

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| `id` | INT | 댓글 ID (자동 증가) |
| `post_id` | INT | 어느 게시글에 달린 댓글인지 |
| `user_id` | INT | 누가 썼는가 |
| `content` | TEXT | 댓글 내용 |
| `created_at` | TIMESTAMP | 작성 날짜 |
| `updated_at` | TIMESTAMP | 수정 날짜 |

```sql
CREATE TABLE comments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    post_id INT NOT NULL,
    user_id INT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**각 컬럼의 역할**:

```
게시글이 삭제되면 → 그 게시글의 댓글도 자동 삭제
user_id 필드 → "누가 이 댓글을 썼는가" 추적
post_id 필드 → "이 댓글은 어느 게시글에 달렸는가" 추적
```

### 1-3 데이터베이스 생성

PHPMyAdmin에서 다음 SQL을 실행:

```sql
USE board_db;

-- comments 테이블 생성
CREATE TABLE comments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    post_id INT NOT NULL,
    user_id INT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 샘플 데이터
INSERT INTO comments (post_id, user_id, content) VALUES 
(1, 1, '좋은 글이네요!'),
(1, 2, '도움이 되었습니다'),
(2, 1, '공감합니다');
```

---

## 2️⃣ 구현 기능

### 2-1 전체 흐름 이해

댓글 기능의 4가지 작업(CRUD):

```
【 댓글 CRUD 흐름 】

C - CREATE (작성)           R - READ (조회)
└─ add_comment.php    ─→   └─ view.php에서 표시
   INSERT 쿼리               SELECT + JOIN 쿼리

U - UPDATE (수정)          D - DELETE (삭제)
└─ edit_comment.php   ←─→  └─ delete_comment.php
   UPDATE 쿼리              DELETE 쿼리
```

**✅ 본인 댓글만 수정/삭제**:
```
WHERE id = ? AND user_id = ?
       ↑              ↑
   댓글 ID   현재 로그인한 사용자
   
→ 자신이 쓴 댓글만 수정/삭제 가능
```

### 2-2 add_comment.php (댓글 추가)

**목적**: 사용자가 새로운 댓글을 작성하는 파일

```php
<?php

require 'config.php';

// 로그인 확인
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit;
}

$error = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        // 입력값 받기
        $post_id = $_POST['post_id'] ?? '';
        // htmlspecialchars()
        // 목적: HTML 특수문자를 안전한 형태로 변환
        // 예: '<script>' → '&lt;script&gt;' (XSS 공격 방지)
        $content = htmlspecialchars(trim($_POST['content'] ?? ''));
        $user_id = $_SESSION['user_id'];
        
        // 검증
        if (empty($post_id) || !is_numeric($post_id)) {
            throw new Exception("게시글이 존재하지 않습니다");
        }
        
        if (empty($content)) {
            throw new Exception("댓글 내용을 입력하세요");
        }
        
        if (strlen($content) > 1000) {
            throw new Exception("댓글은 1000자 이하여야 합니다");
        }
        
        // 게시글 존재 확인
        // SELECT로 post_id가 실제로 존재하는지 확인
        $check_sql = "SELECT id FROM posts WHERE id = ?";
        $check_stmt = $pdo->prepare($check_sql);
        $check_stmt->execute([$post_id]);
        
        if (!$check_stmt->fetch()) {
            throw new Exception("게시글이 존재하지 않습니다");
        }
        
        // 댓글 저장
        // INSERT INTO comments
        // 목적: 새로운 댓글을 데이터베이스에 저장
        // 데이터: post_id(어느 게시글), user_id(누가), content(무엇)
        $sql = "INSERT INTO comments (post_id, user_id, content) VALUES (?, ?, ?)";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$post_id, $user_id, $content]);
        
        // 댓글 추가 후 원래 게시글로 이동
        header("Location: view.php?id=$post_id");
        exit;
        
    } catch (Exception $e) {
        $error = $e->getMessage();
    }
}

// 게시글 ID 받기
$post_id = $_GET['post_id'] ?? '';

?>

<!DOCTYPE html>
<html>
<head>
    <title>댓글 작성</title>
    <style>
        body { font-family: '맑은 고딕'; max-width: 600px; margin: 50px auto; padding: 20px; }
        h1 { color: navy; }
        form { background: #f5f5f5; padding: 15px; }
        textarea { width: 100%; height: 100px; padding: 8px; border: 1px solid #ddd; }
        button { background: navy; color: white; padding: 8px 15px; border: none; cursor: pointer; }
        .error { color: red; padding: 8px; background: #ffe6e6; }
        a { color: navy; text-decoration: none; }
    </style>
</head>
<body>

<h1>💬 댓글 작성</h1>

<?php if ($error): ?>
    <div class="error"><?php echo htmlspecialchars($error); ?></div>
<?php endif; ?>

<form method="POST">
    <input type="hidden" name="post_id" value="<?php echo htmlspecialchars($post_id); ?>">
    <textarea name="content" placeholder="댓글을 입력하세요 (1000자 이내)" required></textarea><br><br>
    <button type="submit">댓글 등록</button>
</form>

<a href="view.php?id=<?php echo htmlspecialchars($post_id); ?>">돌아가기</a>

</body>
</html>
```

### 2-3 view.php 수정 (댓글 표시)

기존 view.php에 **댓글 조회 섹션** 추가:

```php
<?php
// ... 기존 게시글 표시 코드 ...

// 댓글 조회
// SELECT ... FROM comments
// 목적: 이 게시글에 달린 모든 댓글을 조회
// JOIN users: 댓글을 쓴 사람의 이름도 함께 가져오기
// ORDER BY created_at DESC: 최신 댓글부터 표시
$comments_sql = "
    SELECT c.id, c.content, c.created_at, c.updated_at,
           u.username
    FROM comments c
    JOIN users u ON c.user_id = u.id
    WHERE c.post_id = ?
    ORDER BY c.created_at DESC
";
$comments_stmt = $pdo->prepare($comments_sql);
$comments_stmt->execute([$id]);
$comments = $comments_stmt->fetchAll(PDO::FETCH_ASSOC);

?>

<!-- 게시글 내용 표시 (기존 코드) -->

<!-- 댓글 섹션 -->
<hr>
<h2>💬 댓글 (<?php echo count($comments); ?>)</h2>

<?php if (empty($comments)): ?>
    <p style="color: #999;">댓글이 없습니다.</p>
<?php else: ?>
    <?php foreach ($comments as $comment): ?>
        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f9f9f9;">
            <strong><?php echo htmlspecialchars($comment['username']); ?></strong>
            <span style="color: #999; font-size: 12px;">
                <?php echo $comment['created_at']; ?>
            </span>
            <?php if ($comment['created_at'] !== $comment['updated_at']): ?>
                <span style="color: #f44336; font-size: 12px;">(수정됨)</span>
            <?php endif; ?>
            <p><?php echo htmlspecialchars($comment['content']); ?></p>
            
            <!-- 본인의 댓글만 수정/삭제 버튼 표시 -->
            <?php if (isset($_SESSION['user_id']) && $_SESSION['user_id'] == $comment['user_id']): ?>
                <a href="edit_comment.php?id=<?php echo $comment['id']; ?>&post_id=<?php echo $id; ?>">수정</a>
                <a href="delete_comment.php?id=<?php echo $comment['id']; ?>&post_id=<?php echo $id; ?>" onclick="return confirm('삭제하시겠습니까?');">삭제</a>
            <?php endif; ?>
        </div>
    <?php endforeach; ?>
<?php endif; ?>

<!-- 댓글 작성 폼 -->
<?php if (isset($_SESSION['user_id'])): ?>
    <a href="add_comment.php?post_id=<?php echo $id; ?>" style="display: inline-block; margin-top: 15px; padding: 8px 15px; background: navy; color: white; text-decoration: none;">댓글 작성</a>
<?php else: ?>
    <p style="color: #999; margin-top: 15px;">댓글을 작성하려면 <a href="login.php">로그인</a>하세요.</p>
<?php endif; ?>
```

**코드 설명**:

```
【 댓글 표시 과정 】

1. SELECT 쿼리로 댓글 조회
   ↓
2. foreach로 각 댓글 반복
   ↓
3. 댓글 작성자 확인 ($_SESSION['user_id'])
   ↓
4. 본인이면 "수정/삭제" 버튼 표시
   ↓
5. 다른 사람이면 버튼 비표시
```

### 2-4 edit_comment.php (댓글 수정)

```php
<?php

require 'config.php';

// 로그인 확인
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit;
}

$error = '';
$comment = null;
$id = $_GET['id'] ?? null;
$post_id = $_GET['post_id'] ?? null;

if (!$id || !$post_id) {
    die("잘못된 요청입니다");
}

try {
    // 댓글 조회
    // WHERE id = ? AND user_id = ?
    // 목적: 본인의 댓글만 수정 가능하도록 확인
    // 다른 사람의 댓글은 조회 결과가 없으므로 수정 불가능
    $sql = "SELECT id, content FROM comments WHERE id = ? AND user_id = ?";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$id, $_SESSION['user_id']]);
    
    $comment = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$comment) {
        die("댓글을 찾을 수 없습니다");
    }
    
} catch (PDOException $e) {
    die("조회 실패: " . $e->getMessage());
}

// POST 요청 처리 (수정)
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        $content = htmlspecialchars(trim($_POST['content'] ?? ''));
        
        if (empty($content)) {
            throw new Exception("댓글 내용을 입력하세요");
        }
        
        if (strlen($content) > 1000) {
            throw new Exception("댓글은 1000자 이하여야 합니다");
        }
        
        // UPDATE 쿼리
        // 목적: 댓글 내용 업데이트
        // updated_at은 자동으로 현재 시간으로 업데이트됨
        $sql = "UPDATE comments SET content = ? WHERE id = ? AND user_id = ?";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$content, $id, $_SESSION['user_id']]);
        
        header("Location: view.php?id=$post_id");
        exit;
        
    } catch (Exception $e) {
        $error = $e->getMessage();
    }
}

?>

<!DOCTYPE html>
<html>
<head>
    <title>댓글 수정</title>
    <style>
        body { font-family: '맑은 고딕'; max-width: 600px; margin: 50px auto; padding: 20px; }
        h1 { color: navy; }
        form { background: #f5f5f5; padding: 15px; }
        textarea { width: 100%; height: 100px; padding: 8px; border: 1px solid #ddd; }
        button { background: navy; color: white; padding: 8px 15px; border: none; cursor: pointer; }
        .error { color: red; padding: 8px; background: #ffe6e6; }
        a { color: navy; text-decoration: none; }
    </style>
</head>
<body>

<h1>✏️ 댓글 수정</h1>

<?php if ($error): ?>
    <div class="error"><?php echo htmlspecialchars($error); ?></div>
<?php endif; ?>

<form method="POST">
    <textarea name="content" required><?php echo htmlspecialchars($comment['content']); ?></textarea><br><br>
    <button type="submit">수정하기</button>
</form>

<a href="view.php?id=<?php echo htmlspecialchars($post_id); ?>">돌아가기</a>

</body>
</html>
```

### 2-5 delete_comment.php (댓글 삭제)

```php
<?php

require 'config.php';

// 로그인 확인
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit;
}

try {
    $id = $_GET['id'] ?? null;
    $post_id = $_GET['post_id'] ?? null;
    
    if (!$id || !$post_id) {
        throw new Exception("잘못된 요청입니다");
    }
    
    // DELETE 쿼리
    // WHERE id = ? AND user_id = ?
    // 목적: 본인의 댓글만 삭제 가능
    // 다른 사람의 댓글을 삭제하려고 하면 아무것도 삭제되지 않음
    $sql = "DELETE FROM comments WHERE id = ? AND user_id = ?";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$id, $_SESSION['user_id']]);
    
    header("Location: view.php?id=$post_id");
    exit;
    
} catch (Exception $e) {
    die("삭제 실패: " . htmlspecialchars($e->getMessage()));
}

?>
```

---

## 3️⃣ 과제

### 필수 과제

```
1. 데이터베이스 생성
   - board_db에 comments 테이블 생성
   - 샘플 데이터 3개 이상 추가

2. 댓글 기능 구현
   - add_comment.php 구현 및 테스트
   - view.php에 댓글 표시 기능 추가
   - 댓글이 최신순으로 표시되는지 확인

3. 댓글 수정/삭제
   - edit_comment.php 구현
   - delete_comment.php 구현
   - 본인의 댓글만 수정/삭제 가능한지 확인
```

### 선택 과제

```
1. 댓글 작성자 이름 옆에 "작성자" 또는 "관리자" 배지 추가 (12장 미리보기)
2. 댓글 수를 게시글 목록(list.php)에도 표시
3. 댓글 길이 제한을 1000자에서 다른 값으로 변경
```

---

## 4️⃣ 핵심 개념

### JOIN을 이용한 다중 테이블 조회

**문제**: 댓글 정보만으로는 작성자 이름을 모름

```
comments 테이블
│ id: 1, post_id: 1, user_id: 1, content: "좋아요" │
                                  ↑
                              숫자일 뿐

이름이 뭔지 알려면?
→ users 테이블에서 user_id = 1인 사람 찾아야 함
```

**해결책**: JOIN 사용

```php
// 댓글과 작성자 정보를 함께 조회
SELECT c.id, c.content, c.created_at,
       u.username              ← users 테이블의 이름
FROM comments c
JOIN users u ON c.user_id = u.id   ← 두 테이블 연결
WHERE c.post_id = ?
```

**시각화**:

```
comments 테이블              users 테이블
│ id: 1                   │ id: 1
│ user_id: 1     ────────→ │ username: "김철수"
│ content: "..."           │ email: "kim@example.com"


JOIN 결과:
│ id: 1 (댓글 ID)
│ user_id: 1
│ content: "좋아요"
│ username: "김철수" ← JOIN으로 가져옴
```

### FOREIGN KEY 제약

```sql
FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE
```

**의미**:
- 게시글이 삭제되면 → 그 게시글의 댓글도 자동 삭제
- 데이터 일관성 유지 (고아 데이터 방지)

```
게시글 삭제:
┌──────────────────┐
│ DELETE FROM posts│
│ WHERE id = 1     │
└──────────────────┘
        ↓
자동으로 발생:
┌────────────────────────────────┐
│ DELETE FROM comments           │
│ WHERE post_id = 1              │ ← CASCADE
└────────────────────────────────┘
```

### 본인 확인 (보안)

```php
WHERE id = ? AND user_id = ?
```

**작동 방식**:

```
【 댓글 수정 시나리오 】

1️⃣ 사용자 A가 자신의 댓글(id=5) 수정
   UPDATE comments SET content = "..." 
   WHERE id = 5 AND user_id = 1    ← 본인 ID
   
   → 성공! (데이터 변경됨)

2️⃣ 사용자 B가 사용자 A의 댓글(id=5) 수정 시도
   UPDATE comments SET content = "..." 
   WHERE id = 5 AND user_id = 2    ← 다른 사람 ID
   
   → 실패! (WHERE 조건 불일치로 아무것도 변경 안 됨)
```

---

## 5️⃣ 주의사항

1. **댓글 작성자 확인**: 본인의 댓글만 수정/삭제 가능하도록 WHERE에 user_id 필수
2. **입력값 검증**: htmlspecialchars()로 XSS 방지
3. **트랜잭션**: 게시글 삭제 시 댓글도 함께 삭제 (CASCADE 사용)
4. **오류 처리**: try-catch로 데이터베이스 에러 처리

---

수고했습니다.

조정현 교수(peterchokr@gmail.com)
영남이공대학교

