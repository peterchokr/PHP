# 12장: 게시판 고급 기능 (1/2) - 태그 시스템

---

## 📌 이 장에서 배우는 것

### **무엇을 만드나요?**

🏷️ **태그 시스템** - 게시글에 카테고리/주제를 표시하는 기능

### **왜 필요한가요?**

- 🔍 주제별로 게시글을 분류/검색
- 📚 게시글 조직화
- 💡 사용자가 원하는 내용을 쉽게 찾기

### **어떻게 만드나요?**

```
1단계: 다대다 관계 이해 (게시글 ↔ 태그)
2단계: 중간 테이블 설계
3단계: 태그 추가/삭제/검색 기능 구현
```

---

## 학습목표

이 장을 학습하고 나면 다음을 할 수 있습니다:

✅ 다대다(Many-to-Many) 관계를 이해하고 설계할 수 있습니다.
✅ 중간 테이블을 사용하여 태그 시스템을 구현할 수 있습니다.
✅ 태그로 게시글을 검색하고 필터링할 수 있습니다.

---

## 1️⃣ 태그 시스템 데이터베이스 설계

### 1-1 다대다 관계 이해

**게시글과 태그의 관계**:

#### 문제: 일반 외래키로는 안 된다

```
현재 until 9-11장:
users 테이블          posts 테이블
┌──────────────┐    ┌──────────────┐
│ id: 1        │←1:N│ id: 1        │
│ username: 김 │    │ user_id: 1   │
└──────────────┘    └──────────────┘

→ 1명의 사용자 = N개의 게시글 (OK, 외래키로 충분)


새로운 관계:
게시글 테이블          태그 테이블
┌──────────────┐    ┌──────────────┐
│ id: 1        │ N:M│ id: 1        │
│ title: "..." │    │ name: "PHP"  │
└──────────────┘    └──────────────┘

→ 1개 게시글 = N개 태그
→ 1개 태그 = N개 게시글

외래키만으로는 불가능!
```

#### ✅ 해결책: 중간 테이블 사용

```
【 다대다 관계 구조 】

게시글 테이블                 태그 테이블
┌──────────────┐           ┌──────────────┐
│ id: 1        │           │ id: 1        │
│ title: "PHP" │           │ name: "PHP"  │
└──────────────┘           └──────────────┘
       │                           ▲
       │                           │
       └──────┬──────────────┬─────┘
              │              │
       ┌──────────────┐
       │ post_tags    │ ← 중간 테이블
       │ (중간 테이블)│
       ├──────────────┤
       │ post_id: 1   │
       │ tag_id: 1    │
       └──────────────┘

중간 테이블이 게시글과 태그를 연결!
```

#### 📊 현실의 예시

```
┌─────────────────────────────┐
│ 게시글 1번: "PHP 기초 강좌"  │
├─────────────────────────────┤
│ 태그: [PHP] [기초] [튜토리얼] │
└─────────────────────────────┘

데이터베이스:
posts 테이블
│ id=1, title="PHP 기초 강좌" │

tags 테이블
│ id=1, name="PHP"           │
│ id=2, name="기초"          │
│ id=3, name="튜토리얼"      │

post_tags 테이블 (중간 테이블)
│ post_id=1, tag_id=1        │
│ post_id=1, tag_id=2        │
│ post_id=1, tag_id=3        │

→ 1개 게시글 = 3개 태그 저장!
```

### 1-2 테이블 설계

#### tags 테이블 (태그 정보)

```sql
CREATE TABLE tags (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

| 컬럼           | 설명                          |
| -------------- | ----------------------------- |
| `id`         | 태그 ID (자동 증가)           |
| `name`       | 태그 이름 ("PHP", "MySQL" 등) |
| `created_at` | 태그 생성 날짜                |

#### post_tags 테이블 (중간 테이블)

```sql
CREATE TABLE post_tags (
    post_id INT NOT NULL,
    tag_id INT NOT NULL,
    PRIMARY KEY (post_id, tag_id),
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);
```

| 컬럼            | 설명                                                          |
| --------------- | ------------------------------------------------------------- |
| `post_id`     | 게시글 ID                                                     |
| `tag_id`      | 태그 ID                                                       |
| `PRIMARY KEY` | (post_id, tag_id) 조합이 유일함 (같은 태그 2번 붙이지 않도록) |

**왜 복합 PRIMARY KEY인가?**

```
posts_tags (post_id, tag_id)
(1,          1)              ← 게시글1에 태그1 붙임 (OK)
(1,          2)              ← 게시글1에 태그2 붙임 (OK)
(1,          1)              ← 게시글1에 태그1 다시 붙임? (ERROR!)
                                 PRIMARY KEY 중복으로 불가능
```

### 1-3 데이터베이스 생성

```sql
USE board_db;

-- tags 테이블
CREATE TABLE tags (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- post_tags 테이블 (중간 테이블)
CREATE TABLE post_tags (
    post_id INT NOT NULL,
    tag_id INT NOT NULL,
    PRIMARY KEY (post_id, tag_id),
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);

-- 샘플 태그
INSERT INTO tags (name) VALUES ('PHP'), ('MySQL'), ('JavaScript'), ('초급'), ('중급');

-- 샘플 태그 연결 (게시글 1번에 "PHP", "MySQL", "초급" 태그)
INSERT INTO post_tags (post_id, tag_id) VALUES (1, 1), (1, 2), (1, 4);
```

---

## 2️⃣ 태그 기능 구현

### 2-1 전체 흐름 이해

```
【 태그 처리 흐름 】

사용자가 게시글 작성 시 태그 입력:
"PHP, MySQL, 초급"
    ↓
쉼표로 구분하여 배열로 변환:
["PHP", "MySQL", "초급"]
    ↓
각 태그마다:
  1. tags 테이블에 이미 있는지 확인
  2. 없으면 새로 생성
  3. tag_id 얻기
    ↓
post_tags에 관계 저장:
  (post_id=1, tag_id=1)
  (post_id=1, tag_id=2)
  (post_id=1, tag_id=4)
    ↓
list.php에서 태그 클릭하면:
  list.php?tag=PHP
    ↓
그 태그를 가진 게시글만 표시
```

### 2-2 functions.php에 추가할 함수들

```php
<?php

// getPostTags() 함수
// 목적: 특정 게시글에 달린 모든 태그를 조회
// 입력: $pdo (데이터베이스), $post_id (게시글 ID)
// 출력: [['id' => 1, 'name' => 'PHP'], ...] (태그 배열)
function getPostTags($pdo, $post_id) {
    // 중간 테이블을 통한 JOIN
    // post_tags에서 tag_id를 찾고
    // tags에서 해당하는 태그 정보를 조회
  
    // 쿼리 구조:
    // SELECT tags의 정보
    // FROM tags
    // JOIN post_tags (연결 조건: tag_id)
    // WHERE post_id = ?
  
    $sql = "SELECT t.id, t.name 
            FROM tags t
            JOIN post_tags pt ON t.id = pt.tag_id
            WHERE pt.post_id = ?
            ORDER BY t.name";
  
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$post_id]);
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

// getOrCreateTag() 함수
// 목적: 태그가 있으면 반환, 없으면 생성하고 ID 반환
// 입력: $pdo (데이터베이스), $tag_name (태그 이름)
// 출력: 태그 ID
function getOrCreateTag($pdo, $tag_name) {
    // 1단계: 태그 존재 확인
    // SELECT id FROM tags WHERE name = ?
    $sql = "SELECT id FROM tags WHERE name = ?";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$tag_name]);
    $tag = $stmt->fetch();
  
    if ($tag) {
        // 이미 존재하면 그 ID 반환
        return $tag['id'];
    } else {
        // 없으면 새로 생성
        // INSERT INTO tags (name) VALUES (?)
        $insert_sql = "INSERT INTO tags (name) VALUES (?)";
        $insert_stmt = $pdo->prepare($insert_sql);
        $insert_stmt->execute([$tag_name]);
      
        // lastInsertId(): 방금 INSERT한 행의 ID
        // 새로 생성한 태그의 ID를 반환
        return $pdo->lastInsertId();
    }
}

// getAllTags() 함수 (추가 기능)
// 목적: 모든 태그를 조회
// 입력: $pdo (데이터베이스)
// 출력: [['id' => 1, 'name' => 'PHP'], ...] (모든 태그)
function getAllTags($pdo) {
    $sql = "SELECT id, name FROM tags ORDER BY name";
    $stmt = $pdo->prepare($sql);
    $stmt->execute();
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

?>
```

**함수 사용 예시**:

```php
// 게시글 1번의 태그 조회
$tags = getPostTags($pdo, 1);
// 결과: [['id' => 1, 'name' => 'PHP'], ['id' => 2, 'name' => 'MySQL']]

// "JavaScript"라는 태그 얻기 (없으면 생성)
$tag_id = getOrCreateTag($pdo, "JavaScript");
// 결과: 5 (새로 생성됨)

// 모든 태그 조회
$all_tags = getAllTags($pdo);
// 결과: [['id' => 1, 'name' => 'JavaScript'], ['id' => 2, 'name' => 'MySQL'], ...]
```

### 2-3 write.php 수정 (태그 입력)

기존 write.php에 **태그 입력 기능** 추가:

```php
<?php
// ... 기존 파일 업로드 코드 ...

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        // ... 기존 게시글 저장 코드 ...
      
        $post_id = $pdo->lastInsertId();
      
        // ===== 태그 처리 =====
        // textarea에서 입력한 태그를 처리
        $tags_input = trim($_POST['tags'] ?? '');
      
        if (!empty($tags_input)) {
            // explode(',', $tags_input)
            // 목적: 쉼표로 구분된 문자열을 배열로 변환
            // 예: "PHP, MySQL, 초급" → ["PHP", " MySQL", " 초급"]
          
            // array_map('trim', ...)
            // 목적: 배열의 모든 요소의 앞뒤 공백 제거
            // 결과: ["PHP", "MySQL", "초급"]
          
            $tag_names = array_map('trim', explode(',', $tags_input));
          
            // 각 태그를 처리
            foreach ($tag_names as $tag_name) {
                // 빈 태그명 스킵
                if (empty($tag_name)) {
                    continue;
                }
              
                // getOrCreateTag() 함수
                // 목적: 태그가 있으면 ID 반환, 없으면 생성하고 ID 반환
                // 예: getOrCreateTag($pdo, "PHP") → 1 (또는 새로 생성)
                $tag_id = getOrCreateTag($pdo, htmlspecialchars($tag_name));
              
                // post_tags에 관계 저장
                // INSERT INTO post_tags (post_id, tag_id) VALUES (?, ?)
                // 목적: "이 게시글에 이 태그가 있다"는 관계 저장
                $tag_sql = "INSERT INTO post_tags (post_id, tag_id) VALUES (?, ?)";
                $tag_stmt = $pdo->prepare($tag_sql);
                $tag_stmt->execute([$post_id, $tag_id]);
            }
        }
      
        // ... 기존 리다이렉트 코드 ...
        header("Location: view.php?id=$post_id");
        exit;
      
    } catch (Exception $e) {
        $error = $e->getMessage();
    }
}

?>

<!-- HTML 폼에 태그 입력 필드 추가 -->
<form method="POST" enctype="multipart/form-data">
    <input type="text" name="title" placeholder="제목" required>
    <textarea name="content" placeholder="내용" required></textarea>
  
    <!-- 태그 입력 필드 -->
    <div>
        <label>태그 (선택, 쉼표로 구분)</label>
        <input type="text" name="tags" placeholder="예: PHP, MySQL, 초급">
        <p class="info">여러 태그를 쉼표(,)로 구분하여 입력하세요</p>
    </div>
  
    <!-- 파일 업로드 필드 -->
    <input type="file" name="files[]" multiple>
  
    <button type="submit">게시글 등록</button>
</form>
```

### 2-4 view.php 수정 (태그 표시)

```php
<?php
// ... 기존 코드 ...

// 태그 조회
// getPostTags() 함수로 게시글의 모든 태그 조회
$tags = getPostTags($pdo, $id);

?>

<!-- 게시글 내용 (기존) -->

<!-- 태그 섹션 -->
<?php if (!empty($tags)): ?>
    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd;">
        <strong>🏷️ 태그:</strong>
        <?php foreach ($tags as $tag): ?>
            <!-- 태그를 클릭하면 list.php?tag=태그이름으로 이동 -->
            <!-- 그러면 그 태그를 가진 게시글만 표시됨 -->
            <a href="list.php?tag=<?php echo urlencode($tag['name']); ?>" 
               style="display: inline-block; margin: 5px; padding: 5px 10px; 
                      background: navy; color: white; text-decoration: none; 
                      border-radius: 3px;">
                <?php echo htmlspecialchars($tag['name']); ?>
            </a>
        <?php endforeach; ?>
    </div>
<?php endif; ?>
```

### 2-5 list.php 수정 (태그 필터링)

```php
<?php

require 'config.php';
require 'functions.php';

// 페이지 번호
$page = $_GET['page'] ?? 1;
$page = max(1, intval($page));

// 태그 필터링
$tag_filter = $_GET['tag'] ?? '';
$where = "WHERE 1=1";  // 기본값: 조건 없음
$params = [];

if (!empty($tag_filter)) {
    // 특정 태그로 필터링
    // 쿼리 구조:
    // SELECT posts
    // FROM posts
    // JOIN users (작성자 정보)
    // JOIN post_tags (게시글-태그 관계)
    // JOIN tags (태그 이름으로 필터링)
    // WHERE tags.name = ?
  
    $where = "WHERE t.name = ?";
    $params = [$tag_filter];
  
    // INNER JOIN을 사용하여 특정 태그를 가진 게시글만 조회
    $sql = "SELECT p.id, p.title, p.views, p.created_at, u.username
            FROM posts p
            JOIN users u ON p.user_id = u.id
            JOIN post_tags pt ON p.id = pt.post_id
            JOIN tags t ON pt.tag_id = t.id
            $where
            GROUP BY p.id
            ORDER BY p.created_at DESC
            LIMIT 10 OFFSET ?";
  
    $params[] = ($page - 1) * 10;
} else {
    // 일반 목록 조회 (태그 필터링 없음)
    $sql = "SELECT p.id, p.title, p.views, p.created_at, u.username
            FROM posts p
            JOIN users u ON p.user_id = u.id
            ORDER BY p.created_at DESC
            LIMIT 10 OFFSET ?";
  
    $params = [($page - 1) * 10];
}

// ... 나머지 코드 ...

?>
```

**GROUP BY의 역할**:

```
JOIN 후의 결과:
post_id=1, title="PHP 강좌", tag="PHP"
post_id=1, title="PHP 강좌", tag="MySQL"

GROUP BY p.id로 중복 제거:
post_id=1, title="PHP 강좌"

→ 같은 게시글이 여러 번 나오는 것을 방지!
```

---

## 3️⃣ 과제

### 필수 과제

```
1. 데이터베이스 생성
   - tags 테이블 생성
   - post_tags 테이블 생성
   - 샘플 태그 5개 생성

2. 태그 기능 구현
   - write.php에 태그 입력 필드 추가
   - 게시글 작성 시 태그 저장 테스트

3. 태그 표시 및 필터링
   - view.php에 태그 표시
   - list.php에서 태그로 필터링 가능한지 확인
   - 태그 클릭 시 해당 태그를 가진 게시글만 표시되는지 확인
```

### 선택 과제

```
1. 각 태그가 몇 개의 게시글을 가지고 있는지 표시
   예: [PHP (5)], [MySQL (3)]

2. 가장 많이 사용된 태그 TOP 5 표시

3. 게시글 수정 시 태그도 함께 수정 가능하도록 변경
```

---

## 4️⃣ 핵심 개념

### 다대다 관계와 중간 테이블

**1:N 관계 (기존)**:

```
users (1)          posts (N)
┌─────────┐        ┌─────────┐
│ id: 1   │ ←─────→│ user_id │
└─────────┘        └─────────┘

외래키 하나로 충분 (user_id)
```

**N:M 관계 (새로운)**:

```
posts (N)          tags (N)
┌─────────┐        ┌─────────┐
│ id      │        │ id      │
└────┬────┘        └────┬────┘
     │                  │
     └──────┬──────────┘
            │
      ┌─────────────┐
      │ post_tags   │ ← 중간 테이블 필요!
      │ (post_id,   │
      │  tag_id)    │
      └─────────────┘

중간 테이블이 양쪽을 모두 연결
```

### JOIN으로 태그 조회

**문제**: post_tags에는 숫자만 있음

```
post_tags:
post_id=1, tag_id=1
post_id=1, tag_id=2

tag_id=1이 뭐라는 이름인지 모름!
```

**해결책**: JOIN으로 태그 정보 가져오기

```php
// tags 테이블과 join
// tag_id = 1이면 → tags.name = "PHP"를 가져옴

SELECT t.id, t.name
FROM tags t
JOIN post_tags pt ON t.id = pt.tag_id
WHERE pt.post_id = 1;

결과:
id=1, name="PHP"
id=2, name="MySQL"
```

---

## 5️⃣ 주의사항

1. **중복 태그 방지**: `getOrCreateTag()` 함수로 태그 중복 생성 방지
2. **복합 키**: post_tags의 PRIMARY KEY는 (post_id, tag_id) 조합
3. **GROUP BY**: 태그 필터링 시 GROUP BY로 중복 게시글 방지
4. **대소문자**: 태그 검색은 대소문자 구분 고려

---

수고했습니다.

조정현 교수(peterchokr@gmail.com)
영남이공대학교
